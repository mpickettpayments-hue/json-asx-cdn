<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>JSON ASX â€” XJSON</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="./manifest.json" />
<link rel="icon" href="./icon-192.png" />
<script src="https://accounts.google.com/gsi/client" async defer></script>
<link rel="stylesheet" href="./style.css" />
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <img src="./json-asx.jpg" alt="JSON ASX logo" />
      <div>
        <div class="t1">JSON ASX</div>
        <div class="small muted">XJSON Launcher</div>
      </div>
    </div>
    <div class="nav">
      <button data-route="/" class="active">ğŸ  Home</button>
      <button data-route="/store/">ğŸ›’ Store</button>
      <button data-route="/library/">ğŸ® Library</button>
      <button data-route="/downloads/">â¬‡ï¸ Downloads</button>
      <button data-route="/settings/">âš™ï¸ Settings</button>
    </div>

    <div class="channel">
      <span class="chip active" data-channel="latest">latest</span>
      <span class="chip" data-channel="stable">stable</span>
      <span class="chip" data-channel="nightly">nightly</span>
    </div>
  </aside>

  <header class="header">
    <div class="search">
      <input id="q" placeholder="Search library or storeâ€¦" />
    </div>
    <div class="actions">
      <div id="googleBtn"></div>
      <input id="pat" placeholder="Admin GitHub PAT" style="width:200px" />
      <button id="savePat" class="btn">Save PAT</button>
      <button id="refresh" class="btn">Refresh</button>
    </div>
  </header>

  <div class="mainwrap">
    <main class="main" id="main"><div class="muted">Loading XJSONâ€¦</div></main>
    <aside class="builder" id="builder">
      <div class="row">
        <select id="builderTarget"><option value="">Select JSON Appâ€¦</option></select>
        <button id="saveApp" class="btn">Save</button>
      </div>
      <textarea id="appJson" class="code"></textarea>
      <div class="splitHandle"></div>
      <div class="helper">
        <h3>Chat Helper (LangFlow)</h3>
        <div class="row"><input id="langflowUrl" placeholder="Endpoint" /></div>
        <div class="row">
          <input id="chatInput" placeholder="Describe a changeâ€¦" />
          <button id="chatSend" class="btn">Apply</button>
        </div>
        <div id="chatLog" class="small muted"></div>
      </div>
      <button id="publishBtn" class="btn" style="margin-top:10px">Publish to My Domain</button>
    </aside>
  </div>
</div>

<div id="fsOffer" class="fs-offer hidden">
  <span>Tip: Fullscreen for best experience</span>
  <button id="fsGo" class="btn">Go Fullscreen</button>
  <button id="fsDismiss" class="btn">Dismiss</button>
</div>

<script type="module">
  import { initGoogleSignIn } from './auth.js';
  import { ensureUserProvisioned } from './provision.js';
  import { publishAppJson } from './publish.js';
  import { redirectToUserDomain } from './router-tools.js';

  // Load admin PAT if saved
  const patEl = document.getElementById('pat');
  patEl.value = localStorage.getItem('xjson.admin.pat') || '';
  document.getElementById('savePat').onclick = () => {
    localStorage.setItem('xjson.admin.pat', patEl.value.trim());
    alert('PAT saved.');
  };

  // Google Sign-In â†’ Provision â†’ Redirect
  initGoogleSignIn({
    buttonId: 'googleBtn',
    onSignedIn: async ({ uid }) => {
      const token = localStorage.getItem('xjson.admin.pat') || '';
      if (!token) return alert('Admin PAT required first.');
      const r = await ensureUserProvisioned(uid, token);
      redirectToUserDomain(uid); // âœ… R1 behavior
    }
  });
</script>

<script type="module" src="./app.js"></script>
</body>
</html>
